# Splitout Code Automation Webhook
## üöÄ What It Does
Automates a flow using stickyNote√ó22, httpRequest√ó12, set√ó9.

## üíº Business Use Case
Use as a **glue/API broker**: receive data, enrich/validate via APIs, and pass to downstream systems.

## ‚öôÔ∏è How It Works
1. **Trigger:** This workflow starts with **When clicking ‚ÄòTest workflow‚Äô**.
2. **When clicking ‚ÄòTest workflow‚Äô** `manualTrigger` ‚Äî configured for its default action.
3. **Sticky Note** `stickyNote` ‚Äî width: "520", height: "240", content: "## Setting Up Medoids for Anomaly Detection
### Preparatory workflow to set cluster centres and cluster threshold scores, so anomalies can be detected based on these thresholds
Her‚Ä¶[truncated]"
4. **Sticky Note1** `stickyNote` ‚Äî height: "80", content: "Once again, variables for Qdrant: cluster URL and a collection we're working with"
5. **Sticky Note2** `stickyNote` ‚Äî height: "100", content: "Which point in the cluster we're using to draw threshold on: the furthest one from center, or the 2nd, ... Xth furthest one;"
6. **Sticky Note3** `stickyNote` ‚Äî width: "180", height: "240", content: "Here we are getting [facet counts](https://qdrant.tech/documentation/concepts/payload/?q=facet#facet-counts): information which unique values are there behind *"crop_name"* payload‚Ä¶[truncated]"
7. **Sticky Note4** `stickyNote` ‚Äî height: "120", content: "Which point in the cluster we're using to draw threshold on: the furthest one from center, or the 2nd, ... Xth furthest one;
<this is the 2nd approach>"
8. **Sticky Note5** `stickyNote` ‚Äî height: "140", content: "We need to get the [total amount of points](https://qdrant.tech/documentation/concepts/points/?q=count#counting-points) in Qdrant collection to use it as a `limit` in the *"Crop Co‚Ä¶[truncated]"
9. **Sticky Note6** `stickyNote` ‚Äî width: "220", height: "380", content: "Here we're extracting and gathering all the information about crop clusters, so we can call [Qdrant distance matrix API](https://qdrant.tech/documentation/concepts/explore/?q=dista‚Ä¶[truncated]"
10. **Sticky Note8** `stickyNote` ‚Äî height: "200", content: "Hardcoded descriptions on how each crop usually looks; They were generated with chatGPT, and that can be technically done directly in n8n based on the crop name or a crop picture (‚Ä¶[truncated]"
11. **Sticky Note9** `stickyNote` ‚Äî height: "400", content: "Calling [distance matrix API](https://qdrant.tech/documentation/concepts/explore/?q=distance+#distance-matrix) once per cluster. 

`sample` - how many points we are sampling (here ‚Ä¶[truncated]"
12. **Sticky Note10** `stickyNote` ‚Äî width: "150", height: "80", content: "Splitting out into each unique crop cluster"
13. **Sticky Note11** `stickyNote` ‚Äî width: "180", height: "240", content: "Using distance matrix generated by Qdrant and `coo_array` from `scipy`, we're finding a **representative** for each cluster (point which is the most similar to all other points wit‚Ä¶[truncated]"
14. **Sticky Note12** `stickyNote` ‚Äî height: "280", content: "To find a **representative** with this approach, we:
1) Embed descriptions of crops with the same Voyage model we used for images (we can do so, since model is multimodal)
2) For e‚Ä¶[truncated]"
15. **Sticky Note13** `stickyNote` ‚Äî width: "160", height: "140", content: "Embedding descriptions with Voyage model 
[Note] mind `input_type`, it's *"query"*"
16. **Sticky Note14** `stickyNote` ‚Äî height: "260", content: "Find the closest image to the description embeddings (done per cluster)
[Note] Mind `exact` parameter
[Note] `limit` is 1 because vector database always returns points sorted by di‚Ä¶[truncated]"
17. **Sticky Note15** `stickyNote` ‚Äî width: "200", height: "80", content: "Fetching vectors of centres by their IDs"
18. **Sticky Note16** `stickyNote` ‚Äî height: "100", content: "Set in Qdrant *"is_medoid"* [payloads](https://qdrant.tech/documentation/concepts/payload/) for points which were defined as centres by *"distance matrix approach"*"
19. **Sticky Note17** `stickyNote` ‚Äî height: "180", content: "Here, we don't have to fetch a vector by point id as in the *"distance matrix approach"*, since [an API call in the previous node](https://api.qdrant.tech/api-reference/search/quer‚Ä¶[truncated]"
20. **Sticky Note18** `stickyNote` ‚Äî height: "140", content: "Set in Qdrant *"is_text_anchor_medoid"* [payloads](https://qdrant.tech/documentation/concepts/payload/) for points which were defined as centres by *"multimodal embedding model app‚Ä¶[truncated]"
21. **Sticky Note19** `stickyNote` ‚Äî width: "440", height: "100", content: "Starting from here, this and the three following nodes are analogous for both methods, with a difference only in variable names. The goal is to find a **class (cluster) threshold s‚Ä¶[truncated]"
22. **Sticky Note20** `stickyNote` ‚Äî height: "220", content: "Finding the most dissimilar point to a centre vector (within each class) is equivalent to finding the most similar point to the [opposite](https://mathinsight.org/image/vector_oppo‚Ä¶[truncated]"
23. **Sticky Note21** `stickyNote` ‚Äî width: "520", height: "140", content: "So here, we found the most dissimilar point within the crop class to the class centre (or the Xth dissimilar point, depending on a variable set in the beginning of this pipeline). ‚Ä¶[truncated]"
24. **Sticky Note22** `stickyNote` ‚Äî color: "4", width: "540", height: "300"
25. **Qdrant cluster variables** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
26. **Medoids Variables** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
27. **Text Medoids Variables** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
28. **Total Points in Collection** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').item.json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').item.json.collectionName }}/points/count`
29. **Textual (visual) crop descriptions** `set` ‚Äî mode: "raw", options: "[object Object]", jsonOutput: "{"text anchors": [{"cropName": "pearl_millet(bajra)", "cropDescription": "pearl_millet(bajra) - Tall stalks with cylindrical, spiked green grain heads."},
{"cropName": "tobacco-pla‚Ä¶[truncated]"
30. **Crop Counts** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/facet`
31. **Split Out1** `splitOut` ‚Äî options: "[object Object]", fieldToSplitOut: "['text anchors']"
32. **Info About Crop Clusters** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
33. **Split Out** `splitOut` ‚Äî include: "allOtherFields", options: "[object Object]", fieldToSplitOut: "cropNames"
34. **Cluster Distance Matrix** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/search/matrix/offsets`
35. **Merge** `merge` ‚Äî mode: "combine", options: "[object Object]", fieldsToMatchString: "cropName"
36. **Scipy Sparse Matrix** `code` ‚Äî mode: "runOnceForEachItem", language: "python", pythonCode: "from scipy.sparse import coo_array

cluster = _input.item.json['result']

scores = list(cluster['scores'])
offsets_row = list(cluster['offsets_row'])
offsets_col = list(cluster['of‚Ä¶[truncated]"
37. **Embed text** `httpRequest` ‚Äî method: **POST**, url: `https://api.voyageai.com/v1/multimodalembeddings`
38. **Set medoid id** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/payload`
39. **Get Medoid Vector** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points`
40. **Get Medoid by Text** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/query`
41. **Prepare for Searching Threshold** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
42. **Set text medoid id** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/payload`
43. **Prepare for Searching Threshold1** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
44. **Searching Score** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/query`
45. **Searching Text Medoid Score** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/query`
46. **Threshold Score** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
47. **Threshold Score1** `set` ‚Äî options: "[object Object]", assignments: "[object Object]"
48. **Set medoid threshold score** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/payload`
49. **Set text medoid threshold score** `httpRequest` ‚Äî method: **POST**, url: `={{ $('Qdrant cluster variables').first().json.qdrantCloudURL }}/collections/{{ $('Qdrant cluster variables').first().json.collectionName }}/points/payload`

## üí° AI-Powered Ideas for Improvement
- **Explain:** This workflow is designed to set up medoids for anomaly detection using a crops dataset. It identifies cluster centers and establishes threshold scores for each cluster, which are used to detect anomalies. The process involves two methods: a distance matrix approach and a multimodal embedding model approach, both utilizing Qdrant for vector storage and retrieval.

- **Demonstrate:** A data scientist could use this workflow to preprocess a dataset of agricultural crops, setting up a system to automatically detect anomalies in crop images or descriptions. This could help in identifying unusual crop growth patterns or diseases early.

- **Imitate:** To adapt this workflow:
  1. Set up a Qdrant instance and upload your dataset.
  2. Import the workflow into n8n.
  3. Configure Qdrant-related nodes with your instance details.
  4. Adjust the crop descriptions and parameters for your dataset.
  5. Test the workflow to ensure it correctly identifies cluster centers and thresholds.

- **Practice:** Create a small dataset of crop images and descriptions. Use the workflow to process this dataset and identify the medoid and threshold for each crop type. Modify parameters and observe how it affects the results.

- **WIIFM:** Mastering this workflow enables you to offer anomaly detection solutions in sectors like agriculture, where early detection of anomalies can prevent losses. This skill can attract clients looking for advanced data analysis and AI solutions, enhancing your service offerings and potential income.

## üîß Setup Instructions
1. **Connect Credentials:** qdrantApi, httpHeaderAuth.
2. **API Contracts:** Validate required headers and 2xx/4xx handling; add retries for 429/5xx.

### ‚ö†Ô∏è Automation Ain‚Äôt the Same Anymore

Most builders out here are stuck doing $500 workflows and calling it a win.  
That‚Äôs not the move.  

I'm closing $6k‚Äì$13k deals by stacking simple automations with lightweight AI...  
and it takes me under 2 hours to build most of them.

#### üß† Examples From My Own Playbook:
- üîÅ Turned a recurring invoice workflow into a $6,000 retainer that saved 20 hours/week  
- ‚öñÔ∏è Built an AI-powered lead gen engine for law firms ‚Äî they paid $13,000 happily  
- üöÄ Launched an SEO agent that outperforms funded companies ‚Äî using free OpenAI credits  

**Want to learn how to do the same?**  
Inside [Digital Boss Code](https://bigpoppacode.io/go/dbc), I break it all down:

‚úÖ The exact AI components that 3x your pricing overnight  
‚úÖ My $15k Automation Framework using n8n + LangChain  
‚úÖ Word-for-word scripts to close high-ticket deals  
‚úÖ Real client case studies with templates  
‚úÖ How to stop looking like a tech VA and start moving like a Solution Architect  

üî• Get started at ‚Üí [bigpoppacode.io/go/dbc](https://bigpoppacode.io/go/dbc)  
Limited time access, early birds get the best bonuses.

---
> Built by [Big Poppa Code](https://bigpoppacode.io) ‚Äì architecting automations that scale people, profits, and purpose.
